<!DOCTYPE html>
<html>
  <head>
    <title>DeFi Lending Markets - ConsenSys Academy Developer Bootcamp</title>
    <link href="../../../style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js" async></script>
    <script src="../../../text-bounce.js" async></script>
  </head>
  <body>
    <h1 id="defi-lending-markets">DeFi Lending Markets</h1>
<h2 id="the-use-of-lending-markets">The Use of Lending Markets</h2>
<p>Lending is a fundamental financial mechanism in finance and DeFi. Lending helps take excess capital from savers and allocates it to borrowers, putting the funds to productive use. This helps create economic growth while generating a return for savers. It's also used for hedging and mitigating risk. On the other hand, lending creates debt, which, if not properly managed, can cause instability to cascade through connected markets, leading to economic and market contractions. These issues are magnified in DeFi because networks are interdependent and open to anyone.</p>
<p>ðŸ–¼ Flow chart -&gt; expansion -&gt; Debt bubble -&gt; pop -&gt; come down</p>
<p><a href="https://www.leewayhertz.com/how-defi-lending-works/">DeFi lending markets</a> allow users to become borrowers and lenders in a decentralized way without giving up custody of their funds. It is more efficient since it enables permissionless and programmatic access to capital without a credit check. Being on Ethereum means that any program can access these markets, providing a money lego around lending. Using a peer to contract pattern, lenders and borrowers can interact with the contract and simplify negotiating loan terms or managing counterparty risk themselves. This lowers frictions costs and while being scalable.</p>
<h2 id="overcollateralization-as-a-defi-primitive">Overcollateralization as a DeFi Primitive</h2>
<p>Since DeFi protocols are open and pseudonymous, uncollateralized loans are not possible. You have to put up assets to get funds. Providing collateral ensures the counterparty cannot steal the funds or default on a loan. Due to the volatility risk of crypto assets used as collateral, over-collateralization is required. Issuing <a href="https://forum.openzeppelin.com/t/introduction-to-the-overcollateralized-loan-pattern-defi-primitive-and-its-security-considerations/2141">debt via over-collateralization is a typical pattern in DeFi</a>. The pattern can also <a href="https://www.steemleo.com/defi/@culgin/overcollateralization-in-defi-is-it-good-or-bad">help limit the amount of leverage</a>, and <a href="https://docs.aave.com/risk/asset-risk/adding-an-asset">control risk for a protocol</a> since assets need to be greater than liabilities.</p>
<p>Solvency = collateral asset value &gt; liabilities (issued loans aka debt)</p>
<p>The level of over-collateralization is represented by the loan-to-collateral ratio stated by the protocol. The loan-to-collateral ratio is the percentage you can borrow of an asset relative to the collateral deposited. Other names for the same idea include collateral factor, collateral ratio, cFactor or cRatio. Since we cannot borrow more than we deposit, the cFactor is always below 100%. Depending on the quality of the asset, the collateralization ratio is set.</p>
<p>Borrowed value &gt; collateral value * cFactor = All good!</p>
<p>ðŸ–¼ Open &amp; anonymous -&gt; collateral</p>
<p>ðŸ–¼ Volatility -&gt; over collateralization (cFactor &lt; 100%)</p>
<h2 id="debt">Debt</h2>
<p>The ability to add collateral and adjust a token's supply allows for issuing a debt token backed by collateral. This debt token can represent a utility token like a lending market position from <a href="https://medium.com/compound-finance/supplying-assets-to-the-compound-protocol-ec2cf5df5aa">Compound.finance</a> or Aave. For example, in Compound Finance, a DAI debt token would be cDAI, while in Aave aDAI. If DAI's collateral factor is 75%, then with $100 worth of collateral, you can borrow 75 DAI. Other DeFi 101 <a href="https://forum.openzeppelin.com/t/defi-101-concepts-you-need-to-understand-before-using-a-defi-protocol/2577">lending concepts like the importance of price oracles to update price can be found here</a>.</p>
<p>ðŸ–¼ Debt collateral pattern</p>
<p>Collateral -&gt; contract lock -&gt; debt token = collateral * cFactor</p>
<p>----Create Debt----&gt;</p>
<p>Reclaim &lt;- unlock collateral &lt;- pay back loan = collateral + interest accrued</p>
<p>&lt;---Unwind Debt----</p>
<h2 id="loans-and-incentives">Loans and Incentives</h2>
<p><a href="https://indexcoop.substack.com/p/introduction-1-compound-finance">Why would anyone take out an over collateralized loan</a>? Why not just sell the assets? One reason is to avoid or delay paying <a href="https://en.wikipedia.org/wiki/Capital_gains_tax">capital gains taxes</a> when selling. If the user has excess capital, the user can earn interest on their stablecoin. Or to increase their liquidity without having to sell their assets and only having to pay the interest. This liquidity can be used as leverage to short an asset or to fund an unexpected expense.</p>
<p>A user can profit by leveraging a long position or shorting on an asset through lending markets. Going long means expecting the asset's price to appreciate. If the user expects ETH to go up in value, they can deposit their ETH to borrow USDC. Then use USDC to buy more ETH. The user gets exposure to more ETH minus the interest rate. Say the collateral factor is 50% on a deposit of $1000 worth of ETH. The borrower receives 500 USDC and then can buy more ETH. So they can leverage themselves to $1,500 worth of ETH. To turn a profit, the appreciation of ETH should exceed the interest and gas fees required to pay back the loan.</p>
<p>ðŸ–¼ Add graph with a difference.</p>
<p>Going short means expecting the asset will lose value in price. If the user expects ETH to depreciate, they can deposit USDC to borrow ETH. Then sell the ETH and repurchase it later at a lower price, making a profit in the difference. Say ETH is at $1000 when the user sells it. Later, they buy the asset back at $300. They get to pocket $700 minus the interest payment and gas fees.</p>
<p>ðŸ–¼ Add graph with difference.</p>
<h2 id="liquidation-and-incentives">Liquidation and Incentives</h2>
<p>Liquidation involves a user's position being closed to pay the debt incurred. This happens if the collateral's value drops below the acceptable collateral ratio. Lending protocols often use an Oracle service like <a href="http://chainlink">ChainLink</a> and the price feed of a major exchange like Uniswap to provide real-time data about a collateral's value.</p>
<p>Liquidation = Borrowed value &gt; collateral value * cFactor</p>
<p>Since smart contracts cannot act without being called, liquidation occurs by offering incentives to an external entity called a "keeper". The keeper can liquidate the position and keep a percentage fee. Then, the collateral is auctioned off or via a decentralized exchange at market price.</p>
<p>ðŸ–¼ Halting problem -&gt; contracts need to be called -&gt; incentive to call -&gt; keeper to liquidate</p>
<p>In some protocols, everything is auctioned off. In others, the remaining collateral is left in the original contract. An example can be if the collateralization ratio is 200% and the user only placed the bare minimum. If the asset drops 1%, the protocol will liquidate 2% of the collateral. Since liquidation is costly, some protocols allow users to add additional collateral if needed, similar to a <a href="https://www.investopedia.com/terms/m/margincall.asp">margin call</a>. It is wise to add a margin of safety in addition to the collateral ratio.</p>
<p>Margin of Safety = cFactor + extraCapital &gt; volatility</p>
<p>ðŸ–¼ graph with volatility line shorter band than collateralization ratio.</p>
<p>Applications: Compound Finance and Aave</p>
<p>An application of lending markets are money markets. Within DeFi open-source algorithmic money market protocols allow anyone to borrow or lend cryptocurrency assets by only providing collateral. These lending markets connect lenders who wish to earn <a href="https://www.investopedia.com/terms/i/interest.asp">interest</a> and borrowers who want to borrow for various reasons and pay interest. Users can provide assets with d liquidity like ETH, WITH, DAI, USDT, USDC, LINK, etc.</p>
<p>The two leading platforms are <a href="https://compound.finance/documents/Compound.Whitepaper.pdf">Compound.finance</a> and <a href="https://github.com/aave/aave-protocol/blob/master/docs/Aave_Protocol_Whitepaper_v1_0.pdf">Aave</a> (ghost in Finnish). Explained in the links, <a href="https://www.gemini.com/cryptopedia/what-is-compound-and-how-does-it-work">Compound Finance</a> and <a href="https://docs.aave.com/developers/v/1.0/developing-on-aave/the-protocol/lendingpool">Aave</a> work by using <a href="https://finematics.com/lending-and-borrowing-in-defi-explained/">lending pools</a>. A lending pool locks up capital and generates an algorithmically determined interest rate based on supply and demand. You can learn how to use <a href="https://www.youtube.com/watch?v=IDzdrM4xjYw">Aave</a> and Compound.</p>
<h2 id="interest-and-lending">Interest and Lending</h2>
<p>Lending requires borrowers and lenders. Borrowers pay interest while lenders earn interest. Whether you borrow or lend, you must lock up capital into a lending pool inside a contract. In return, you earn a debt token, in Compound's case a cToken, derived from the asset in question. DAI, you get cDAI, BAT renders cBAT and so on. This token accrues interest over time and can be traded or used as collateral in other protocols. For the lender to unlock their collateral, they must pay the interest accrued plus the collateral. For both Aave and Compound, there is no time period to close the loan.</p>
<p>Lending can occur with variable rate interest based on market demand or fixed interest rates. Variable interest rates adjust due to the demand and supply for the asset in question. The key to note is that the borrow interest rate is always higher than the supply rate.</p>
<p>Demand &gt; supply = interest rate go up</p>
<p>Demand &lt; supply = interest rate go down</p>
<p>Borrow APY &gt; Supply APY</p>
<p>Lending protocols operate in real-time. Rates are adjusted, and interest is accrued every new Ethereum block. Interest is typically <a href="https://medium.com/compound-finance/faq-1a2636713b69">accrued to the debt token</a> or accounts tied to the lending pool. Aave lets users redirect their stream of interest to other contracts.</p>
<p>Aave offers a <a href="https://docs.aave.com/faq/borrowing#:~:text=The%20variable%20rate%20is%20the,rate%20depending%20on%20market%20conditions.">stable interest rate</a>, which means it's fixed for a short term and can change depending on borrowing and lending dynamics of the pool. <a href="https://messari.io/article/fixed-income-protocols-the-next-wave-of-defi-innovation">Other platforms</a> offer fixed interest rates, like <a href="https://notional.finance/">Notional</a>, <a href="https://88mph.app/">88mph</a> and <a href="https://barnbridge.com/">Barnbridge</a>.</p>
<p>Typically, the longer the loan, the higher the risk, the higher the interest rate. On Ethereum, we measure time in blocks. What if we went in reverse? If a loan and a position could be executed in the same block, what happens? We get flash loans!</p>
<p>ðŸ–¼ interest rate graph - grows over time. At origin 0,0, it can be almost no interest and no collateral, aka a flash loan.</p>
<h2 id="flash-loans-as-a-defi-primitive">Flash Loans as a DeFi Primitive</h2>
<p>DeFi allows the creation of something called <a href="https://www.gemini.com/cryptopedia/aave-flashloans#section-aave-flash-loans">Flash Loans</a>. Introduced by Aave, flash loans are the first uncollateralized loans that can be accessed in a permissionless way. This means that anyone anywhere can access large sums of capital. They are <a href="https://finematics.com/flash-loans-explained/">explained here</a>.</p>
<p>Flash Loans only have one condition: Payback the loan within 1 Ethereum block. Since all protocols share the same database on Ethereum, flash loans can interact with various protocols in one block to find opportunities. The loan only goes through if the transaction results in the loan being repaid. If not, the entire transaction reverts, like it was never sent!</p>
<p>A cool application of <a href="https://medium.com/@bneiluj/flash-boys-arbitrage-dao-c0b96d094f93#:~:text=About%20ArbitrageDAO%20%7C%20Flash%20Boys&amp;text=It%20uses%20a%20combination%20of,in%20the%20decentralized%20finance%20ecosystem.">Flash Loans</a> is the ability to do Flash Swaps. Learn how to create <a href="https://blog.infura.io/build-a-flash-loan-arbitrage-bot-on-infura-part-i/">Flash Swaps with Infura here.</a> This can be used to hedge against liquidation risk by swapping a volatile asset into a stable asset!</p>
<h2 id="risks">Risks</h2>
<p>With DeFi Lending Markets, there is zero counterparty risk. However, smart contract risk always exists. Duration risk comes in borrowers being hit with spiking variable borrowing APY rates if they are not paying attention. This can cause a user to get liquidated by having to repay more than expected. When hedging, there is the risk of the trade going the other way.</p>
    <br /><div class="footer">
    <a href="https://github.com/ConsenSys-Academy/Blockchain-Developer-Bootcamp/edit/main/docs/S05a-defi/M7-defi-lending/L1/index.md" target="_blank">Edit this page on Github</a>
    
    <div class="discord">
        <img class="discord-logo" src="../../../discord.svg" alt="Discord logo" ><a href="https://discord.gg/FrHSjSn9dX" target="_blank" >Questions? Ask on Discord! </a>  
    </div> 
</div>
  </body>
</html>